CREATE OR REPLACE FUNCTION STATS_APEX.QA_FORMAT_COLUMNS(FORMAT_TYPE VARCHAR2, VALUE1 VARCHAR2, VALUE2 VARCHAR2 DEFAULT NULL, VALUE3 VARCHAR2 DEFAULT NULL) RETURN VARCHAR2
AS 
RESULT VARCHAR2(510);


BEGIN

CASE FORMAT_TYPE

WHEN 'JOIN' THEN

FOR i IN (SELECT FIRST.COLUMN_VALUE||' = '||SECOND.COLUMN_VALUE||' AND ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST
JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE2,':'))) SECOND
ON FIRST.NUM = SECOND.NUM)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-5);

WHEN 'UNJOIN' THEN

FOR i IN (SELECT FIRST.COLUMN_VALUE||' <> '||SECOND.COLUMN_VALUE||' OR ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST
JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE2,':'))) SECOND
ON FIRST.NUM = SECOND.NUM)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-4);

WHEN 'PERCENT' THEN

FOR i IN (SELECT '('||FIRST.COLUMN_VALUE||' - '||SECOND.COLUMN_VALUE||')/(CASE WHEN '||FIRST.COLUMN_VALUE||'=0 THEN CASE WHEN '||SECOND.COLUMN_VALUE||'=0 THEN 1 ELSE '||SECOND.COLUMN_VALUE||' END ELSE '||FIRST.COLUMN_VALUE||' END)'||THIRD.COLUMN_VALUE||' OR ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST
JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE2,':'))) SECOND
ON FIRST.NUM = SECOND.NUM
LEFT JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE3,':'))) THIRD
ON SECOND.NUM = THIRD.NUM)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-4);

WHEN 'PERCENTABS' THEN

FOR i IN (SELECT '('||FIRST.COLUMN_VALUE||' - '||SECOND.COLUMN_VALUE||')/(CASE WHEN '||FIRST.COLUMN_VALUE||'=0 THEN CASE WHEN '||SECOND.COLUMN_VALUE||'=0 THEN 1 ELSE '||SECOND.COLUMN_VALUE||' END ELSE '||FIRST.COLUMN_VALUE||' END))'||THIRD.COLUMN_VALUE||' OR ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST
JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE2,':'))) SECOND
ON FIRST.NUM = SECOND.NUM
LEFT JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE3,':'))) THIRD
ON SECOND.NUM = THIRD.NUM)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-4);


WHEN 'PERCENTHEADER' THEN

FOR i IN (SELECT '% DIFFERENCE ('||FIRST.COLUMN_VALUE||'|'||SECOND.COLUMN_VALUE||')'',''' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST
JOIN (SELECT ROWNUM NUM,COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE2,':'))) SECOND
ON FIRST.NUM = SECOND.NUM)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-3);

WHEN 'ISNULLAND' THEN

FOR i IN (SELECT FIRST.COLUMN_VALUE||' IS NULL AND ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-4);


WHEN 'ISNULLOR' THEN

FOR i IN (SELECT FIRST.COLUMN_VALUE||' IS NULL OR ' AS COMBINED
FROM(SELECT ROWNUM NUM, COLUMN_VALUE FROM TABLE(STRING_TO_SELECTABLE_TABLE(VALUE1,':'))) FIRST)

LOOP
RESULT:= RESULT||i.COMBINED;
END LOOP;

RESULT:=SUBSTR(RESULT,0,LENGTH(RESULT)-4);


END CASE FORMAT_TYPE;

RETURN RESULT;

END;
/
